# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Quick Reference

### Most Common Commands
```bash
# Development
npm run dev          # Start Next.js dev server (http://localhost:3000)
npm run build        # Build static export to /out directory
npm run preview      # Serve production build locally (port 3003)
npm run lint         # Run ESLint
npm test             # Run Vitest test suite
npm run test:ui      # Run Vitest with UI

# Deployment
./deploy.sh          # Full build and serve on port 3005
./debug_build.sh     # Build with debug output

# Docker deployment
docker build -t cg-iptc .
docker run -p 80:80 cg-iptc
```

### Key File Locations
- **Project documentation**: `/docs/` (PRD, Architecture, UX Design, Epics, Stories)
- **Project context**: `/docs/project_context.md` (Critical rules for AI agents)
- **Components**: `/components/` (Organized by feed/, layout/, ui/)
- **Pages**: `/app/` (Next.js App Router structure)
- **Utilities**: `/lib/` (substack-parser.ts, utils.ts)
- **Static assets**: `/public/`
- **Build output**: `/out/` (generated by `next build`)

## Architecture Overview

This is the **Clay-Gilmore Institute for Philosophy, Technology, and Counterinsurgency (CG-IPTC)** website - a premium academic/research institute web application built with Next.js 15+ as a **hybrid static site** with dynamic feed integration.

### Core Technology Stack
- **Framework**: Next.js 15+ (App Router, Static Export mode)
- **Language**: TypeScript 5+ (Strict Mode)
- **Styling**: Tailwind CSS 4+
- **Build Tool**: Turbopack (dev) / Next.js bundler (production)
- **Testing**: Vitest 3+ with React Testing Library
- **Data Fetching**: SWR (client-side) for Substack/YouTube feeds
- **URL State**: nuqs for shareable visualization states
- **Visualizations**: @visx/* (Airbnb's data visualization library)
- **Package Manager**: npm

### Architectural Pattern: Hybrid Static Site
- **Static Core**: Pages and layouts generated at build time (`output: 'export'`)
- **Dynamic Feeds**: Client-side components fetch Substack RSS and YouTube feeds using SWR
- **No Backend**: Zero server-side runtime - relies entirely on external APIs (Substack, YouTube)
- **Deployment**: Static HTML/CSS/JS served via Nginx in Docker container

### Design Philosophy
- **Premium "Newsletter" Aesthetic**: High-efficiency legibility, expensive feel, minimal clutter
- **Mobile-First**: Optimized for iOS Safari (Dynamic Island awareness, safe areas)
- **Atomic Design**: Strict component hierarchy (atoms → molecules → organisms → templates → features)
- **Accessibility**: WCAG 2.1 AA compliance (semantic HTML, ARIA labels, contrast ratios)
- **Performance**: Web Vitals targets (LCP < 2.5s, CLS < 0.1)

## Project Structure

### Component Organization (Atomic Design)
```
components/
├── feed/              # Feed-specific organisms
│   ├── HeroArticle.tsx      # Hero section with latest Substack article
│   ├── RecentUpdatesList.tsx # List of recent articles
│   ├── EmptyState.tsx       # Empty/error state UI
│   └── HeroSkeleton.tsx     # Loading state skeleton
├── layout/            # Layout organisms
│   ├── Navbar.tsx           # Main navigation
│   ├── TwoColumnShell.tsx   # Two-column layout wrapper
│   └── GraphDrawer.tsx      # Side drawer for data visualizations
├── ui/                # Reusable atoms/molecules (shadcn/ui)
└── ErrorBoundary.tsx  # App-wide error boundary
```

### App Router Structure
```
app/
├── layout.tsx         # Root layout (fonts, metadata, global styles)
├── page.tsx           # Homepage (Substack feed hero + recent updates)
├── about/page.tsx     # About page
└── exhibitions/page.tsx # Exhibitions archive
```

### Utilities & Libraries
```
lib/
├── substack-parser.ts      # RSS feed parser for Substack integration
├── substack-parser.test.ts # Unit tests for parser (edge cases, malformed XML)
└── utils.ts                # Shared utilities (cn() for class merging)
```

### Documentation
```
docs/
├── prd.md                    # Product Requirements Document
├── architecture.md           # Architecture Decision Document
├── project_context.md        # Critical rules for AI agents (READ FIRST)
├── ux-design-specification.md # UX design guidelines
├── epics.md                  # Epic-level user stories
└── sprint-artifacts/stories/ # Individual user story markdown files
```

## Development Workflow

### TypeScript Rules (Strict Mode)
- **No `any` types**: Use explicit interfaces for all data structures
- **Import patterns**:
  - Type-only imports: `import type { ... }` (required for tree-shaking)
  - Internal imports: Use `@/` alias (e.g., `@/components/ui/button`)
  - **Avoid**: Relative paths deeper than one level (`../../`)
- **Export patterns**:
  - Use **named exports** for components: `export function Button...`
  - **Avoid**: `export default` (except Next.js pages/layouts where required)
- **Async patterns**:
  - Server Components: Use `async/await` directly
  - Client Components: **NEVER** use `async` on component function - use `useSWR` or `useEffect`

### Next.js 15+ Specifics
- **Server Components**: Default for all `app/` components unless marked with `'use client'`
- **Client Components**: Required for hooks (`useState`, `useEffect`, `useSWR`) and event handlers
- **Params as Promises**: `params` and `searchParams` in page props are **Promises** - must `await` before use
- **Static Export**: `output: 'export'` in `next.config.ts` - no server runtime, all routes pre-rendered

### Data Fetching Strategy
- **Static Content**: Server Components for build-time generation (About, Exhibitions pages)
- **Dynamic Feeds**: Client Components with `useSWR` for runtime fetching
  - **NEVER** use `useEffect` for data fetching - always use SWR
  - **NEVER** fetch RSS in `generateStaticParams` or Server Components (breaks static export)
- **Error Handling**: All feed components wrapped in Error Boundaries (site must survive feed failures)
- **Sanitization**: All Substack HTML sanitized with `dompurify` before rendering (XSS prevention)

### Styling with Tailwind
- **Utility-first**: Use Tailwind classes exclusively - no inline styles or CSS modules
- **Conditional classes**: Use `cn()` utility (from `lib/utils.ts`) for merging/conditional classes
- **Typography**: Custom font stack configured in `app/layout.tsx`:
  - Serif: Source Serif 4 (`--font-serif`)
  - Sans: Inter (`--font-inter`)
  - Display: Spectral SC (`--font-spectral-sc`)
  - UI: Lexend Deca (`--font-lexend`)
  - Headlines: Oswald (`--font-oswald`)

### Testing Requirements
- **Framework**: Vitest (faster than Jest, native Vite integration)
- **Unit Tests**: Mandatory for all `lib/` utilities, especially `substack-parser.ts`
  - Focus: Edge cases (empty feeds, malformed XML, regex safety)
- **Component Tests**: Use `@testing-library/react` for "happy path" rendering
  - Ensure components don't crash on render
  - **NEVER** make real network requests - mock `useSWR` responses
- **Run before commit**: `npm test` must pass before pushing

### Code Quality Standards
- **Linting**: Follow `eslint-config-next` defaults
- **Naming Conventions**:
  - Components: `PascalCase.tsx` (match export name)
  - Utilities: `kebab-case.ts`
  - Constants: `UPPER_SNAKE_CASE`
- **Documentation**:
  - Complex logic: JSDoc required for all `lib/` functions
  - UI components: Self-documenting code preferred, comments only for "why" not "what"

### Version Control
- **Branching**: `feature/name` or `fix/issue-name`
- **Commits**: Conventional Commits mandatory (e.g., `feat: add hero article`, `fix: substack parser regex`)
- **Pre-push**: Ensure `npm run build` passes locally (Next.js build errors are build-time)

## Critical Implementation Rules

### Component Architecture Constraints
- **Atomic Design Hierarchy**: Atoms → Molecules → Organisms → Templates → Features
  - **NEVER** import upwards (e.g., organisms can't import from features)
  - Atoms: No business logic, base elements only (buttons, inputs, icons)
  - Molecules: Simple groups, local UI state only (forms, nav links)
  - Organisms: Complex sections, can fetch data (Navbar, ArticleCard)
  - Features: Domain-specific ecosystems composing organisms (SubstackFeed)
- **Client Component Boundaries**: Add `'use client'` directive at the **top** of files using hooks or event listeners

### Hydration Safety
- **NEVER** use `window` or `document` in component body - wrap in `useEffect`
- **NEVER** render dynamic data directly in JSX (Date.now(), Math.random()) unless:
  - Inside `useEffect`, OR
  - Using `suppressHydrationWarning` attribute
- **Feed Components**: Must handle SSR/CSR mismatches gracefully (skeleton → content)

### Error Handling & Resilience
- **Mandatory Error Boundaries**: All `components/feed/*` wrapped in Error Boundary
  - If Substack fails, rest of site must survive
- **API Rate Limiting**: SWR config must handle 429 errors (no infinite retry loops)
- **Feed Sanitization**: All RSS HTML sanitized with `dompurify` before render (prevent XSS/layout breakage)

### SEO & Performance
- **Meta Tags**: Configured in `app/layout.tsx` (OpenGraph, Twitter Cards)
- **Images**: `unoptimized: true` in `next.config.ts` (required for static export)
- **Web Vitals**: Target LCP < 2.5s, CLS < 0.1
- **Loading States**: Custom skeletons authorized to mask asset initialization (style over speed)

## Deployment

### Production Build Process
1. **Clean**: Remove `.next`, `out`, build caches
2. **Build**: `npm run build` → generates static export in `/out`
3. **Verify**: Check build logs for errors, warnings
4. **Serve**: Static files served via Nginx (Docker) or `npx serve`

### Docker Deployment
- **Multi-stage build**: Node builder → Nginx runner
- **Build stage**: `npm ci` → `npm run build` → outputs to `/out`
- **Runtime stage**: Nginx serves `/out` on port 80
- **Config**: Custom `nginx.conf` for SPA routing (fallback to index.html)

### Environment Configuration
- **Base URL**: `https://cg-iptc.org` (configured in metadata)
- **No environment variables**: All config is build-time static
- **Substack Feed**: Fetched client-side from public RSS endpoint

## Troubleshooting

### Common Issues
1. **Hydration Mismatch Errors**:
   - Check for `window`/`document` usage outside `useEffect`
   - Verify server/client render output matches (especially in feed components)

2. **Build Failures**:
   - Run `npm run build` locally to see full error stack
   - Check TypeScript strict mode errors
   - Verify all imports resolve correctly

3. **Feed Not Loading**:
   - Check browser console for CORS errors
   - Verify Substack RSS endpoint is accessible
   - Check SWR error states in DevTools

4. **Static Export Issues**:
   - Ensure `output: 'export'` in `next.config.ts`
   - Verify no server-side runtime code (getServerSideProps, etc.)
   - Check `images.unoptimized: true` is set

### Debug Commands
```bash
# Check build output
npm run build 2>&1 | tee build.log

# Test production build locally
npm run preview

# Run tests in watch mode
npm test -- --watch

# Check for type errors
npx tsc --noEmit
```

## Key Documentation References
- **Before implementing code**: Read `/docs/project_context.md` for critical rules
- **For architectural decisions**: See `/docs/architecture.md`
- **For design guidelines**: See `/docs/ux-design-specification.md`
- **For user stories**: Check `/docs/sprint-artifacts/stories/`

## Important Notes
- This project uses **Next.js 15+ App Router** exclusively (no Pages Router)
- All data is **read-only** - no user authentication, no backend writes
- **External dependencies**: Substack RSS feed, YouTube API (via client-side fetch)
- **Design system**: Custom Atomic Design implementation (not shadcn/ui exactly, but inspired)
- **Testing philosophy**: Focus on critical paths (parser edge cases, component rendering), not exhaustive coverage
