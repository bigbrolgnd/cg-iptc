server {
    listen 80;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    # Disable absolute redirects to preserve the port (e.g. localhost:3005)
    absolute_redirect off;

    # Disable gzip for HTML to allow sub_filter to work
    gzip off;

    # Enable sub_filter to inject recovery script into HTML
    sub_filter_once on;
    sub_filter_types text/html;
    # Inject recovery script immediately after <head> - runs BEFORE any chunk scripts
    # This script: 1) Catches chunk load errors, 2) Redirects with cache-busting param, 3) Prevents infinite loops
    sub_filter '<head>' '<head><script>!function(){if(location.search.includes("_cb=")){sessionStorage.removeItem("chunkRetry");return}var r=sessionStorage.getItem("chunkRetry");window.addEventListener("error",function(e){var t=e.target;if(t&&"SCRIPT"===t.tagName&&t.src&&t.src.includes("/_next/")&&!r){sessionStorage.setItem("chunkRetry","1");var u=location.href.split("?")[0]+"?_cb="+Date.now();location.replace(u)}},!0);window.addEventListener("load",function(){setTimeout(function(){sessionStorage.removeItem("chunkRetry")},5e3)})}();</script>';

    # HTML files - never cache (always check for new version)
    # This prevents blank screen issues after deployments
    location ~* \.html$ {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        # Serve the exact HTML file requested
        try_files $uri =404;
    }

    # Next.js static assets with content hashes - cache for 1 year
    # These files have unique hashes, safe to cache aggressively
    location /_next/static/ {
        add_header Cache-Control "public, max-age=31536000, immutable";
        try_files $uri =404;
    }

    # Other static assets (images, fonts, etc.) - cache for 1 week
    location ~* \.(jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|webp|avif|pdf)$ {
        add_header Cache-Control "public, max-age=604800";
        try_files $uri =404;
    }

    # Default location - no cache for HTML routes
    location / {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        # IMPORTANT: Next.js static export often outputs routes as `/<route>.html`.
        # Some routes may also have a same-named *directory* (e.g. `out/about/`)
        # containing `__next.*.txt` artifacts, but no `index.html`.
        # If we check `$uri` first, nginx will match the directory and return a blank/403 page.
        # So we prioritize `$uri.html`.
        try_files $uri.html $uri $uri/ =404;
    }

    error_page 404 /404.html;
    location = /404.html {
        internal;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
}
